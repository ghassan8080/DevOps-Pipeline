pipeline {
  agent any
  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/ghassan8080/DevOps-Pipeline.git', branch: 'main'
      }
    }

    stage('Verify Kubernetes Setup') {
      steps {
        sh '''
          echo "=== Verifying kubectl installation ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config version --client || echo "kubectl client not found"
          echo "=== Verifying Minikube installation ==="
          minikube version || echo "minikube not found"
          echo "=== Verifying Kubernetes connection ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config cluster-info || echo "Kubernetes cluster not accessible"
          echo "=== Listing available nodes ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config get nodes || echo "Cannot list nodes"
        '''
      }
    }

    stage('Deploy Microservices') {
      steps {
        sh '''
          echo "=== Checking Kubernetes configuration ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config config view || echo "Cannot view config"
          echo "=== Checking current context ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config config current-context || echo "Cannot get current context"
          echo "=== Listing available contexts ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config config get-contexts || echo "Cannot list contexts"
          echo "=== Checking cluster connectivity ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config cluster-info || echo "Cluster not accessible"
          echo "=== Listing files in kubernetes directory ==="
          ls -la kubernetes/ || echo "Cannot list kubernetes directory"
          echo "=== Applying Kubernetes manifests ==="
          kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config apply -f kubernetes/ -v=8 || echo "Failed to apply manifests"
        '''
      }
    }

    stage('Deploy Monitoring') {
      steps {
        sh 'kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config apply -f kubernetes/prometheus-deployment.yaml || echo "Failed to deploy prometheus"'
        sh 'kubectl --kubeconfig=/var/snap/jenkins/4928/.kube/config apply -f kubernetes/grafana-deployment.yaml || echo "Failed to deploy grafana"'
      }
    }
  }
}